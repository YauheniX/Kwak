name: Build Android APK

# Trigger the workflow on push to main branch or when a tag is pushed
on:
  push:
    branches:
      - main
    tags:
      - '*'

jobs:
  build-android:
    name: Build Android Debug APK
    runs-on: ubuntu-latest
    
    # Set minimal permissions for GITHUB_TOKEN for security
    permissions:
      contents: write  # Required for creating releases on tag push
      
    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Node.js environment with latest LTS version
      # This is required to install dependencies and build the project
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      # Step 3: Install npm dependencies
      # This installs all packages defined in package.json
      - name: Install dependencies
        run: npm ci

      # Step 4: Build the Vite + TypeScript project
      # This compiles TypeScript and bundles the Phaser game into the dist folder
      - name: Build project
        run: npm run build

      # Step 5: Install Capacitor CLI globally
      # Capacitor is used to wrap the web app for Android
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli @capacitor/core @capacitor/android

      # Step 6: Initialize Capacitor if not already initialized
      # This creates capacitor.config.ts and sets up the project
      - name: Initialize Capacitor
        run: |
          if [ ! -f "capacitor.config.ts" ] && [ ! -f "capacitor.config.json" ]; then
            npx cap init "Kwak" "com.yauheni.kwak" --web-dir=dist
          fi

      # Step 7: Add Android platform to Capacitor
      # This creates the android directory with the native Android project
      - name: Add Android platform
        run: |
          if [ ! -d "android" ]; then
            npx cap add android
          fi

      # Step 8: Sync web assets to Android platform
      # This copies the built web app (dist folder) to the Android project
      - name: Sync Capacitor
        run: npx cap sync android

      # Step 9: Set up Java Development Kit (JDK)
      # Required for building Android apps with Gradle
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Step 10: Set up Android SDK
      # Install required Android SDK components for API level 31+
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # Step 11: Install Android SDK build tools and platform
      # API level 34 is used for modern Android development
      - name: Install Android SDK components
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      # Step 12: Grant execute permission to gradlew
      # The Gradle wrapper needs execute permissions to run
      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # Step 13: Build the debug APK using Gradle
      # This compiles the Android app and generates app-debug.apk
      - name: Build Android Debug APK
        run: |
          cd android
          ./gradlew assembleDebug --no-daemon

      # Step 14: Upload the generated APK as a workflow artifact
      # The APK can be downloaded from the Actions tab
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: kwak-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      # Step 15: Create a release and upload APK if this is a tag push
      # This makes the APK available as a release asset for tagged versions
      - name: Create Release with APK
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: android/app/build/outputs/apk/debug/app-debug.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
